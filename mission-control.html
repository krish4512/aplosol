<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplosol Mission Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #fff;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            margin-bottom: 30px;
            border-bottom: 2px solid #4b7fff;
            padding-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .header-left h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .meta {
            font-size: 13px;
            color: #cbd5e1;
        }
        
        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }
        
        .sync-info {
            font-size: 11px;
            color: #cbd5e1;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .refresh-btn {
            background: linear-gradient(135deg, #4b7fff 0%, #7c3aed 100%);
            border: none;
            color: #fff;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(75, 127, 255, 0.3);
        }
        
        .refresh-btn:active {
            transform: translateY(0);
        }
        
        .refresh-btn.loading {
            opacity: 0.7;
            pointer-events: none;
        }
        
        .refresh-icon {
            display: inline-block;
        }
        
        .refresh-icon.spinning {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(75, 127, 255, 0.1);
            border: 1px solid rgba(75, 127, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-card.health-green {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.2);
        }
        
        .stat-card.health-orange {
            background: rgba(249, 115, 22, 0.1);
            border-color: rgba(249, 115, 22, 0.2);
        }
        
        .stat-card.health-red {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.2);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: 900;
            color: #4b7fff;
            margin-bottom: 5px;
        }
        
        .stat-card.health-green .stat-number {
            color: #22c55e;
        }
        
        .stat-card.health-orange .stat-number {
            color: #f97316;
        }
        
        .stat-card.health-red .stat-number {
            color: #ef4444;
        }
        
        .stat-label {
            font-size: 12px;
            color: #cbd5e1;
        }
        
        .legend {
            background: rgba(75, 127, 255, 0.05);
            border: 1px solid rgba(75, 127, 255, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .legend h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #e0e7ff;
        }
        
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .legend-item {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        
        .legend-emoji {
            font-size: 24px;
            min-width: 30px;
            text-align: center;
        }
        
        .legend-text {
            flex: 1;
        }
        
        .legend-text strong {
            display: block;
            color: #e0e7ff;
            margin-bottom: 3px;
        }
        
        .legend-text small {
            color: #cbd5e1;
            font-size: 12px;
        }
        
        .tasks-section {
            margin-bottom: 30px;
        }
        
        .tasks-section h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #e0e7ff;
        }
        
        .task-list {
            border: 1px solid rgba(75, 127, 255, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .task-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(75, 127, 255, 0.1);
            font-size: 13px;
        }
        
        .task-item:last-child {
            border-bottom: none;
        }
        
        .task-item:nth-child(odd) {
            background: rgba(75, 127, 255, 0.02);
        }
        
        .task-status {
            font-size: 16px;
            min-width: 25px;
            text-align: center;
        }
        
        .task-priority {
            font-size: 16px;
            min-width: 25px;
            text-align: center;
        }
        
        .task-name {
            flex: 1;
            color: #e0e7ff;
        }
        
        .task-sla {
            min-width: 100px;
            text-align: center;
            font-size: 12px;
            color: #cbd5e1;
        }
        
        .task-item.sla-healthy {
            border-left: 4px solid #4ade80;
        }
        
        .task-item.sla-at-risk {
            border-left: 4px solid #facc15;
            background: rgba(250, 204, 21, 0.02);
        }
        
        .task-item.sla-breached {
            border-left: 4px solid #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }
        
        .sla-health {
            font-weight: 700;
        }
        
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            background: rgba(75, 127, 255, 0.1);
            border: 1px solid rgba(75, 127, 255, 0.3);
            color: #e0e7ff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-btn:hover {
            background: rgba(75, 127, 255, 0.2);
        }
        
        .filter-btn.active {
            background: #4b7fff;
            border-color: #4b7fff;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
        }
        
        .search-box input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(75, 127, 255, 0.1);
            border: 1px solid rgba(75, 127, 255, 0.3);
            border-radius: 6px;
            color: #e0e7ff;
            font-size: 12px;
        }
        
        .search-box input::placeholder {
            color: #7c3aed;
        }
        
        .status-group {
            margin-bottom: 20px;
        }
        
        .status-title {
            font-size: 14px;
            font-weight: 700;
            color: #cbd5e1;
            margin-bottom: 10px;
            padding: 0 15px;
        }
        
        .priority-emoji {
            font-size: 14px;
        }
        
        .footer {
            text-align: center;
            color: #7c3aed;
            font-size: 12px;
            padding-top: 20px;
            border-top: 1px solid rgba(75, 127, 255, 0.1);
            margin-top: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <h1>üéØ Aplosol Mission Control</h1>
                <p class="meta">Website Optimization Sprint | Real-time Task Tracking</p>
            </div>
            <div class="header-right">
                <button class="refresh-btn" onclick="manualRefresh()" id="refreshBtn" title="Manually sync tasks from GitHub">
                    <span class="refresh-icon" id="refreshIcon">üîÑ</span> Sync Now
                </button>
                <div class="sync-info">
                    <div class="sync-dot" id="syncDot"></div>
                    <span>Last sync: <span id="lastSyncTime">Loading...</span></span>
                </div>
            </div>
        </header>
        
        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalTasks">0</div>
                <div class="stat-label">Total Tasks</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="completedTasks">0</div>
                <div class="stat-label">‚úÖ Completed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="inProgressTasks">0</div>
                <div class="stat-label">üîÑ In Progress</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingTasks">0</div>
                <div class="stat-label">‚è≥ Pending</div>
            </div>
        </div>
        
        <!-- SLA Health Summary -->
        <div class="stats">
            <div class="stat-card health-green">
                <div class="stat-number" id="slaHealthy">0</div>
                <div class="stat-label">üü¢ Healthy</div>
            </div>
            <div class="stat-card health-orange">
                <div class="stat-number" id="slaAtRisk">0</div>
                <div class="stat-label">üü† At Risk</div>
            </div>
            <div class="stat-card health-red">
                <div class="stat-number" id="slaBreached">0</div>
                <div class="stat-label">üî¥ Breached</div>
            </div>
        </div>
        
        <!-- Legend -->
        <div class="legend">
            <h2>üìñ Legend</h2>
            <div class="legend-grid">
                <div>
                    <strong>Status</strong>
                    <div class="legend-item">
                        <div class="legend-emoji">‚è≥</div>
                        <div class="legend-text"><strong>To Do</strong> <small>Waiting to start</small></div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-emoji">üîÑ</div>
                        <div class="legend-text"><strong>In Progress</strong> <small>Active work</small></div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-emoji">‚úÖ</div>
                        <div class="legend-text"><strong>Completed</strong> <small>Done</small></div>
                    </div>
                </div>
                
                <div>
                    <strong>Priority</strong>
                    <div class="legend-item">
                        <div class="legend-emoji">üî•</div>
                        <div class="legend-text"><strong>P0</strong> <small>Critical (4h SLA)</small></div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-emoji">‚ö†Ô∏è</div>
                        <div class="legend-text"><strong>P1</strong> <small>High (12h SLA)</small></div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-emoji">üü°</div>
                        <div class="legend-text"><strong>P2</strong> <small>Normal (24h SLA)</small></div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-emoji">üü¢</div>
                        <div class="legend-text"><strong>P3</strong> <small>Low (72h SLA)</small></div>
                    </div>
                </div>
                
                <div>
                    <strong>SLA Health</strong>
                    <div class="legend-item">
                        <div class="legend-emoji">üü¢</div>
                        <div class="legend-text"><strong>Healthy</strong> <small>&lt;75% used</small></div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-emoji">üü†</div>
                        <div class="legend-text"><strong>At Risk</strong> <small>‚â•75% used</small></div>
                    </div>
                    <div class="legend-item">
                        <div class="legend-emoji">üî¥</div>
                        <div class="legend-text"><strong>Breached</strong> <small>SLA exceeded</small></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filter Bar -->
        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterByStatus('all')" data-filter="all">All</button>
            <button class="filter-btn" onclick="filterByStatus('in-progress')" data-filter="in-progress">üîÑ In Progress</button>
            <button class="filter-btn" onclick="filterByStatus('pending')" data-filter="pending">‚è≥ Pending</button>
            <button class="filter-btn" onclick="filterByStatus('completed')" data-filter="completed">‚úÖ Completed</button>
            <button class="filter-btn" onclick="filterByPriority('P0')" data-filter="p0">üî• P0 Only</button>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search tasks..." onkeyup="applyFilters()">
            </div>
            <button class="filter-btn" onclick="toggleCompleted()" id="toggleBtn">Hide Completed</button>
        </div>
        
        <!-- Tasks by Status -->
        <div class="tasks-section">
            <h2>üìã Active Tasks</h2>
            <div class="task-list" id="taskList">
                <div class="task-item" style="justify-content: center; color: #cbd5e1;">
                    Loading tasks...
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Last updated: <span id="lastUpdated">Loading...</span></p>
            <p>Auto-updated every 2 hours | Status: LIVE</p>
        </div>
    </div>
    
    <script>
        let allTasks = [];
        let currentStatusFilter = 'all';
        let currentPriorityFilter = null;
        let hideCompletedTasks = false;
        
        // Parse priority from task name
        function parsePriority(taskName) {
            const match = taskName.match(/\[(P[0-3])\]/);
            return match ? match[1] : 'P3'; // Default to P3
        }
        
        // Get priority emoji
        function getPriorityEmoji(priority) {
            const emojis = { 'P0': 'üî•', 'P1': '‚ö†Ô∏è', 'P2': 'üü°', 'P3': 'üü¢' };
            return emojis[priority] || 'üü°';
        }
        
        // Get SLA duration in milliseconds
        function getSLADuration(priority) {
            const slas = { 'P0': 4 * 60 * 60 * 1000, 'P1': 12 * 60 * 60 * 1000, 'P2': 24 * 60 * 60 * 1000, 'P3': 72 * 60 * 60 * 1000 };
            return slas[priority] || slas['P3'];
        }
        
        // Parse timestamp from task line (format: - [status] task (YYYY-MM-DD HH:MM))
        function parseTimestamp(line) {
            const match = line.match(/\((\d{4}-\d{2}-\d{2} \d{2}:\d{2})\)/);
            return match ? new Date(match[1]) : null;
        }
        
        // Calculate SLA health
        function calculateSLAHealth(task) {
            if (task.status === 'Completed') return 'healthy'; // Completed tasks are always healthy
            
            const startTime = task.startedTime ? new Date(task.startedTime) : new Date();
            const now = new Date();
            const elapsed = now - startTime;
            const slaDuration = getSLADuration(task.priority);
            const percentUsed = (elapsed / slaDuration) * 100;
            
            if (percentUsed >= 100) return 'breached';
            if (percentUsed >= 75) return 'at-risk';
            return 'healthy';
        }
        
        // Format remaining time
        function formatRemainingTime(task) {
            if (task.status === 'Completed') return '‚úÖ Done';
            
            const startTime = task.startedTime ? new Date(task.startedTime) : new Date();
            const now = new Date();
            const elapsed = now - startTime;
            const slaDuration = getSLADuration(task.priority);
            const remaining = slaDuration - elapsed;
            
            if (remaining <= 0) return 'üî¥ Breached';
            
            const hours = Math.floor(remaining / (60 * 60 * 1000));
            const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
            
            return `${hours}h ${minutes}m`;
        }
        
        // Parse TASKS.md and render
        async function loadTasks() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/krish4512/aplosol/main/TASKS.md?t=' + Date.now());
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                }
                
                const tasksText = await response.text();
                
                // Handle empty TASKS.md
                if (!tasksText || tasksText.trim().length === 0) {
                    throw new Error('TASKS.md is empty');
                }
                
                const tasks = [];
                let parseErrors = 0;
                
                tasksText.split('\n').forEach((line, idx) => {
                    try {
                        if (line.match(/^- \[‚úÖ\]/)) {
                            const cleanName = line.replace(/^- \[‚úÖ\]/, '').trim();
                            if (cleanName.length === 0) {
                                parseErrors++;
                                return;
                            }
                            const priority = parsePriority(cleanName);
                            const completedTime = parseTimestamp(line);
                            tasks.push({
                                id: idx,
                                name: cleanName,
                                status: 'Completed',
                                priority: priority,
                                completedTime: completedTime
                            });
                        } else if (line.match(/^- \[üîÑ\]/)) {
                            const cleanName = line.replace(/^- \[üîÑ\]/, '').trim();
                            if (cleanName.length === 0) {
                                parseErrors++;
                                return;
                            }
                            const priority = parsePriority(cleanName);
                            const startedTime = parseTimestamp(line);
                            tasks.push({
                                id: idx,
                                name: cleanName,
                                status: 'In Progress',
                                priority: priority,
                                startedTime: startedTime
                            });
                        } else if (line.match(/^- \[ \]/)) {
                            const cleanName = line.replace(/^- \[ \]/, '').trim();
                            if (cleanName.length === 0) {
                                parseErrors++;
                                return;
                            }
                            const priority = parsePriority(cleanName);
                            tasks.push({
                                id: idx,
                                name: cleanName,
                                status: 'Pending',
                                priority: priority
                            });
                        }
                    } catch (e) {
                        console.warn(`Parse error on line ${idx}:`, e);
                        parseErrors++;
                    }
                });
                
                if (tasks.length === 0 && parseErrors > 0) {
                    throw new Error(`No valid tasks parsed (${parseErrors} parse errors)`);
                }
                
                allTasks = tasks;
                applyFilters();
                updateSyncStatus('success');
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                updateSyncStatus('error', error.message);
                document.getElementById('taskList').innerHTML = `<div class="task-item" style="justify-content: center; color: #f97316;">‚ö†Ô∏è Error: ${error.message || 'Failed to load tasks from GitHub'}</div>`;
            }
        }
        
        // Update sync status indicator
        function updateSyncStatus(status, errorMsg = '') {
            const syncDot = document.getElementById('syncDot');
            const lastSyncSpan = document.getElementById('lastSyncTime');
            const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            if (status === 'success') {
                syncDot.style.background = '#4ade80';
                lastSyncSpan.textContent = now;
            } else if (status === 'error') {
                syncDot.style.background = '#ef4444';
                lastSyncSpan.innerHTML = `<span title="${errorMsg}">${now} ‚ö†Ô∏è</span>`;
            } else if (status === 'loading') {
                syncDot.style.background = '#f97316';
                lastSyncSpan.textContent = 'Syncing...';
            }
        }
        
        // Manual refresh trigger
        function manualRefresh() {
            const refreshBtn = document.getElementById('refreshBtn');
            const refreshIcon = document.getElementById('refreshIcon');
            
            refreshBtn.classList.add('loading');
            refreshIcon.classList.add('spinning');
            updateSyncStatus('loading');
            
            loadTasks().finally(() => {
                refreshBtn.classList.remove('loading');
                refreshIcon.classList.remove('spinning');
            });
        }
        
        function applyFilters() {
            let filtered = allTasks;
            
            // Status filter
            if (currentStatusFilter !== 'all') {
                filtered = filtered.filter(t => {
                    if (currentStatusFilter === 'in-progress') return t.status === 'In Progress';
                    if (currentStatusFilter === 'pending') return t.status === 'Pending';
                    if (currentStatusFilter === 'completed') return t.status === 'Completed';
                    return true;
                });
            }
            
            // Priority filter
            if (currentPriorityFilter) {
                filtered = filtered.filter(t => t.priority === currentPriorityFilter);
            }
            
            // Hide completed
            if (hideCompletedTasks) {
                filtered = filtered.filter(t => t.status !== 'Completed');
            }
            
            // Search filter
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            if (searchTerm) {
                filtered = filtered.filter(t => t.name.toLowerCase().includes(searchTerm));
            }
            
            renderTasks(filtered);
        }
        
        function filterByStatus(status) {
            currentStatusFilter = status;
            currentPriorityFilter = null;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-filter="${status}"]`).classList.add('active');
            applyFilters();
        }
        
        function filterByPriority(priority) {
            currentPriorityFilter = priority;
            currentStatusFilter = 'all';
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-filter="p0"]`).classList.add('active');
            applyFilters();
        }
        
        function toggleCompleted() {
            hideCompletedTasks = !hideCompletedTasks;
            document.getElementById('toggleBtn').textContent = hideCompletedTasks ? 'Show Completed' : 'Hide Completed';
            applyFilters();
        }
        
        function renderTasks(tasks) {
            const stats = {
                total: allTasks.length,
                completed: allTasks.filter(t => t.status === 'Completed').length,
                inProgress: allTasks.filter(t => t.status === 'In Progress').length,
                pending: allTasks.filter(t => t.status === 'Pending').length
            };
            
            // Calculate SLA health summary (for active tasks only)
            const activeTasks = allTasks.filter(t => t.status !== 'Completed');
            const slaHealthCount = {
                healthy: activeTasks.filter(t => calculateSLAHealth(t) === 'healthy').length,
                'at-risk': activeTasks.filter(t => calculateSLAHealth(t) === 'at-risk').length,
                breached: activeTasks.filter(t => calculateSLAHealth(t) === 'breached').length
            };
            
            // Update stats
            document.getElementById('totalTasks').textContent = stats.total;
            document.getElementById('completedTasks').textContent = stats.completed;
            document.getElementById('inProgressTasks').textContent = stats.inProgress;
            document.getElementById('pendingTasks').textContent = stats.pending;
            
            // Update SLA health counts
            document.getElementById('slaHealthy').textContent = slaHealthCount.healthy;
            document.getElementById('slaAtRisk').textContent = slaHealthCount['at-risk'];
            document.getElementById('slaBreached').textContent = slaHealthCount.breached;
            
            // Group tasks by status
            const grouped = {
                'In Progress': tasks.filter(t => t.status === 'In Progress').sort((a, b) => calculateSLAHealth(b).localeCompare(calculateSLAHealth(a))),
                'Pending': tasks.filter(t => t.status === 'Pending'),
                'Completed': tasks.filter(t => t.status === 'Completed')
            };
            
            let html = '';
            
            Object.entries(grouped).forEach(([status, taskList]) => {
                if (taskList.length === 0) return;
                
                const statusEmoji = status === 'In Progress' ? 'üîÑ' : status === 'Pending' ? '‚è≥' : '‚úÖ';
                html += `<div class="status-group">
                    <div class="status-title">${statusEmoji} ${status} (${taskList.length})</div>`;
                
                taskList.forEach(task => {
                    const slaHealth = calculateSLAHealth(task);
                    const slaHealthClass = `sla-${slaHealth}`;
                    const priorityEmoji = getPriorityEmoji(task.priority);
                    const remainingTime = formatRemainingTime(task);
                    
                    html += `<div class="task-item ${slaHealthClass}">
                        <div class="task-status">${status === 'In Progress' ? 'üîÑ' : status === 'Pending' ? '‚è≥' : '‚úÖ'}</div>
                        <div class="task-priority priority-emoji">${priorityEmoji}</div>
                        <div class="task-name">${task.name}</div>
                        <div class="task-sla sla-health">${remainingTime}</div>
                    </div>`;
                });
                
                html += '</div>';
            });
            
            document.getElementById('taskList').innerHTML = html || '<div class="task-item" style="justify-content: center; color: #cbd5e1;">No tasks match filters</div>';
            document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
        }
        
        // Load on page load
        loadTasks();
        
        // Auto-refresh every 2 minutes (120000ms)
        setInterval(loadTasks, 120000);
        
        // Update sync time display on page load
        setTimeout(() => {
            document.getElementById('lastSyncTime').textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }, 500);
    </script>
</body>
</html>
